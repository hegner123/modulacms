// Code generated by tools/dbgen; DO NOT EDIT.
package db

import (
	"context"
	"database/sql"
	"fmt"

	mdbm "github.com/hegner123/modulacms/internal/db-mysql"
	mdbp "github.com/hegner123/modulacms/internal/db-psql"
	mdb "github.com/hegner123/modulacms/internal/db-sqlite"
	"github.com/hegner123/modulacms/internal/db/audited"
	"github.com/hegner123/modulacms/internal/db/types"
)

///////////////////////////////
// STRUCTS
//////////////////////////////

// {{.Entity.Name}} represents a {{lower .Entity.Singular}} record in the database.
type {{.Entity.Name}} struct {
{{- range .Entity.Fields}}
	{{.AppName}} {{.Type}} `json:"{{.JSONTag}}"`
{{- end}}
}

// Create{{.Entity.Singular}}Params contains parameters for creating a new {{lower .Entity.Singular}}.
type Create{{.Entity.Singular}}Params struct {
{{- range .Entity.CreateFields}}
	{{.AppName}} {{.Type}} `json:"{{.JSONTag}}"`
{{- end}}
}

// Update{{.Entity.Singular}}Params contains parameters for updating an existing {{lower .Entity.Singular}}.
type Update{{.Entity.Singular}}Params struct {
{{- range .Entity.NonIDUpdateFields}}
	{{.AppName}} {{.Type}} `json:"{{.JSONTag}}"`
{{- end}}
{{- range .Entity.Fields}}
{{- if and .IsPrimaryID .InUpdate}}
	{{.AppName}} {{.Type}} `json:"{{.JSONTag}}"`
{{- end}}
{{- end}}
}
{{range $di, $driver := .Drivers}}
{{$de := driverEntity $.Entity $driver}}
///////////////////////////////
// {{driverLabel $driver}}
//////////////////////////////
{{- if not $.Entity.SkipMappers}}

// MAPS

// Map{{$.Entity.Singular}} converts a sqlc-generated {{driverCommentLabel $driver}} {{lower $.Entity.Singular}} to the wrapper type.
func (d {{$driver.Struct}}) Map{{$.Entity.Singular}}(a {{$driver.Package}}.{{$.Entity.SqlcTypeName}}) {{$.Entity.Name}} {
	return {{$.Entity.Name}}{
{{- range $.Entity.Fields}}
		{{.AppName}}: a.{{.SqlcFieldName}},
{{- end}}
	}
}

// MapCreate{{$.Entity.Singular}}Params converts wrapper params to sqlc-generated {{driverCommentLabel $driver}} params.
func (d {{$driver.Struct}}) MapCreate{{$.Entity.Singular}}Params(a Create{{$.Entity.Singular}}Params) {{$driver.Package}}.Create{{$.Entity.Singular}}Params {
{{- if and $.Entity.CallerSuppliedID $.Entity.IDIsTyped}}
	id := a.{{$.Entity.IDField}}
	if id.IsZero() {
		id = {{$.Entity.NewIDFunc}}
	}
{{- else if $.Entity.CallerSuppliedID}}
	id := a.{{$.Entity.IDField}}
	if id == "" {
		id = {{$.Entity.NewIDFunc}}
	}
{{- end}}
	return {{$driver.Package}}.Create{{$.Entity.Singular}}Params{
{{- if not $.Entity.CallerSuppliedID}}
		{{$.Entity.IDField}}: {{$.Entity.NewIDFunc}},
{{- else}}
		{{$.Entity.IDField}}: id,
{{- end}}
{{- range $.Entity.NonIDCreateFields}}
		{{.SqlcFieldName}}: a.{{.AppName}},
{{- end}}
	}
}

// MapUpdate{{$.Entity.Singular}}Params converts wrapper params to sqlc-generated {{driverCommentLabel $driver}} params.
func (d {{$driver.Struct}}) MapUpdate{{$.Entity.Singular}}Params(a Update{{$.Entity.Singular}}Params) {{$driver.Package}}.Update{{$.Entity.Singular}}Params {
	return {{$driver.Package}}.Update{{$.Entity.Singular}}Params{
{{- range $.Entity.NonIDUpdateFields}}
		{{.SqlcFieldName}}: a.{{.AppName}},
{{- end}}
{{- range $.Entity.Fields}}
{{- if and .IsPrimaryID .InUpdate}}
		{{.SqlcFieldName}}: a.{{.AppName}},
{{- end}}
{{- end}}
	}
}
{{- end}}

// QUERIES

// Count{{$.Entity.Plural}} returns the total number of {{lower $.Entity.Plural}} in the database.
func (d {{$driver.Struct}}) Count{{$.Entity.Plural}}() (*int64, error) {
	queries := {{$driver.Package}}.New(d.Connection)
	c, err := queries.{{$.Entity.CountQueryName}}(d.Context)
	if err != nil {
		return nil, fmt.Errorf("%v", err)
	}
	return &c, nil
}

// Create{{$.Entity.Singular}}Table creates the {{$.Entity.TableName}} table in the database.
func (d {{$driver.Struct}}) Create{{$.Entity.Singular}}Table() error {
	queries := {{$driver.Package}}.New(d.Connection)
	err := queries.{{$.Entity.CreateTableQueryName}}(d.Context)
	return err
}

// Create{{$.Entity.Singular}} inserts a new {{lower $.Entity.Singular}} and records an audit event.
func (d {{$driver.Struct}}) Create{{$.Entity.Singular}}(ctx context.Context, ac audited.AuditContext, s Create{{$.Entity.Singular}}Params) (*{{$.Entity.Name}}, error) {
	cmd := d.New{{$.Entity.Singular}}Cmd(ctx, ac, s)
	result, err := audited.Create(cmd)
	if err != nil {
		return nil, fmt.Errorf("failed to create {{lower $.Entity.Singular}}: %w", err)
	}
	r := d.Map{{$.Entity.Singular}}(result)
	return &r, nil
}

// Delete{{$.Entity.Singular}} removes a {{lower $.Entity.Singular}} and records an audit event.
func (d {{$driver.Struct}}) Delete{{$.Entity.Singular}}(ctx context.Context, ac audited.AuditContext, id {{$.Entity.IDType}}) error {
	cmd := d.Delete{{$.Entity.Singular}}Cmd(ctx, ac, id)
	return audited.Delete(cmd)
}

{{- if not $.Entity.SkipGet}}

// Get{{$.Entity.Singular}} retrieves a {{lower $.Entity.Singular}} by ID.
func (d {{$driver.Struct}}) Get{{$.Entity.Singular}}(id {{$.Entity.IDType}}) (*{{$.Entity.Name}}, error) {
	queries := {{$driver.Package}}.New(d.Connection)
	row, err := queries.{{$.Entity.GetQueryName}}(d.Context, {{$driver.Package}}.{{$.Entity.GetQueryName}}Params{ {{- $.Entity.IDField}}: id})
	if err != nil {
		return nil, err
	}
	res := d.Map{{$.Entity.Singular}}(row)
	return &res, nil
}
{{- end}}

// List{{$.Entity.Plural}} retrieves all {{lower $.Entity.Plural}} in the database.
func (d {{$driver.Struct}}) List{{$.Entity.Plural}}() (*[]{{$.Entity.Name}}, error) {
	queries := {{$driver.Package}}.New(d.Connection)
	rows, err := queries.{{$.Entity.ListQueryName}}(d.Context)
	if err != nil {
		return nil, fmt.Errorf("failed to get {{$.Entity.Name}}: %v\n", err)
	}
	res := []{{$.Entity.Name}}{}
	for _, v := range rows {
		m := d.Map{{$.Entity.Singular}}(v)
		res = append(res, m)
	}
	return &res, nil
}
{{- if $.Entity.HasPaginated}}

// List{{$.Entity.Plural}}Paginated retrieves a paginated list of {{lower $.Entity.Plural}}.
func (d {{$driver.Struct}}) List{{$.Entity.Plural}}Paginated(params PaginationParams) (*[]{{$.Entity.Name}}, error) {
	queries := {{$driver.Package}}.New(d.Connection)
	rows, err := queries.List{{$.Entity.Singular}}Paginated(d.Context, {{$driver.Package}}.List{{$.Entity.Singular}}PaginatedParams{
		Limit:  {{paginationCast $driver "params.Limit"}},
		Offset: {{paginationCast $driver "params.Offset"}},
	})
	if err != nil {
		return nil, fmt.Errorf("failed to get {{$.Entity.Name}}: %v\n", err)
	}
	res := []{{$.Entity.Name}}{}
	for _, v := range rows {
		m := d.Map{{$.Entity.Singular}}(v)
		res = append(res, m)
	}
	return &res, nil
}
{{- end}}

// Update{{$.Entity.Singular}} modifies an existing {{lower $.Entity.Singular}} and records an audit event.
func (d {{$driver.Struct}}) Update{{$.Entity.Singular}}(ctx context.Context, ac audited.AuditContext, s Update{{$.Entity.Singular}}Params) (*string, error) {
	cmd := d.Update{{$.Entity.Singular}}Cmd(ctx, ac, s)
	if err := audited.Update(cmd); err != nil {
		return nil, fmt.Errorf("failed to update {{lower $.Entity.Singular}}: %w", err)
	}
	msg := fmt.Sprintf("Successfully updated %v\n", {{$.Entity.UpdateSuccessField}})
	return &msg, nil
}
{{end}}
{{- if not .Entity.SkipAuditedCommands}}
// ========== AUDITED COMMAND TYPES ==========
{{range $di, $driver := .Drivers}}
{{$de := driverEntity $.Entity $driver}}
// ----- {{driverCommentLabel $driver}} CREATE -----

// New{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}} is an audited command for creating {{lower $.Entity.Plural}}{{if ne $driver.CmdSuffix ""}} in {{driverCommentLabel $driver}}{{end}}.
type New{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}} struct {
	ctx      context.Context
	auditCtx audited.AuditContext
	params   Create{{$.Entity.Singular}}Params
	conn     *sql.DB
	recorder audited.ChangeEventRecorder
}

// Context returns the command context.
func (c New{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}}) Context() context.Context              { return c.ctx }

// AuditContext returns the audit context.
func (c New{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}}) AuditContext() audited.AuditContext     { return c.auditCtx }

// Connection returns the database connection.
func (c New{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}}) Connection() *sql.DB                   { return c.conn }

// Recorder returns the change event recorder.
func (c New{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}}) Recorder() audited.ChangeEventRecorder { return c.recorder }

// TableName returns the table name for this command.
func (c New{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}}) TableName() string                     { return "{{$.Entity.TableName}}" }

// Params returns the parameters for this command.
func (c New{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}}) Params() any                           { return c.params }

// GetID extracts the ID from a {{lower $.Entity.Singular}} record.
func (c New{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}}) GetID(u {{$driver.Package}}.{{$.Entity.SqlcTypeName}}) string { return {{$.Entity.IDToString (print "u." $.Entity.IDField)}} }

// Execute creates the {{lower $.Entity.Singular}} in the database.
{{- if $driver.MysqlReturningGap}}
func (c New{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}}) Execute(ctx context.Context, tx audited.DBTX) ({{$driver.Package}}.{{$.Entity.SqlcTypeName}}, error) {
{{- if and $.Entity.CallerSuppliedID $.Entity.IDIsTyped}}
	id := c.params.{{$.Entity.IDField}}
	if id.IsZero() {
		id = {{$.Entity.NewIDFunc}}
	}
{{- else if $.Entity.CallerSuppliedID}}
	id := c.params.{{$.Entity.IDField}}
	if id == "" {
		id = {{$.Entity.NewIDFunc}}
	}
{{- end}}
	queries := {{$driver.Package}}.New(tx)
	params := {{$driver.Package}}.Create{{$.Entity.Singular}}Params{
{{- if not $.Entity.CallerSuppliedID}}
		{{$.Entity.IDField}}: {{$.Entity.NewIDFunc}},
{{- else}}
		{{$.Entity.IDField}}: id,
{{- end}}
{{- range $.Entity.NonIDCreateFields}}
		{{.SqlcFieldName}}: c.params.{{.AppName}},
{{- end}}
	}
	if err := queries.Create{{$.Entity.Singular}}(ctx, params); err != nil {
		return {{$driver.Package}}.{{$.Entity.SqlcTypeName}}{}, err
	}
	return queries.{{$.Entity.GetQueryName}}(ctx, {{$driver.Package}}.{{$.Entity.GetQueryName}}Params{ {{- $.Entity.IDField}}: params.{{$.Entity.IDField}}})
}
{{- else}}
func (c New{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}}) Execute(ctx context.Context, tx audited.DBTX) ({{$driver.Package}}.{{$.Entity.SqlcTypeName}}, error) {
{{- if and $.Entity.CallerSuppliedID $.Entity.IDIsTyped}}
	id := c.params.{{$.Entity.IDField}}
	if id.IsZero() {
		id = {{$.Entity.NewIDFunc}}
	}
{{- else if $.Entity.CallerSuppliedID}}
	id := c.params.{{$.Entity.IDField}}
	if id == "" {
		id = {{$.Entity.NewIDFunc}}
	}
{{- end}}
	queries := {{$driver.Package}}.New(tx)
	return queries.Create{{$.Entity.Singular}}(ctx, {{$driver.Package}}.Create{{$.Entity.Singular}}Params{
{{- if not $.Entity.CallerSuppliedID}}
		{{$.Entity.IDField}}: {{$.Entity.NewIDFunc}},
{{- else}}
		{{$.Entity.IDField}}: id,
{{- end}}
{{- range $.Entity.NonIDCreateFields}}
		{{.SqlcFieldName}}: c.params.{{.AppName}},
{{- end}}
	})
}
{{- end}}

// New{{$.Entity.Singular}}Cmd creates a command for inserting a {{lower $.Entity.Singular}}.
func (d {{$driver.Struct}}) New{{$.Entity.Singular}}Cmd(ctx context.Context, auditCtx audited.AuditContext, params Create{{$.Entity.Singular}}Params) New{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}} {
	return New{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}}{ctx: ctx, auditCtx: auditCtx, params: params, conn: d.Connection, recorder: {{$driver.Recorder}}}
}

// ----- {{driverCommentLabel $driver}} UPDATE -----

// Update{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}} is an audited command for updating {{lower $.Entity.Plural}}{{if ne $driver.CmdSuffix ""}} in {{driverCommentLabel $driver}}{{end}}.
type Update{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}} struct {
	ctx      context.Context
	auditCtx audited.AuditContext
	params   Update{{$.Entity.Singular}}Params
	conn     *sql.DB
	recorder audited.ChangeEventRecorder
}

// Context returns the command context.
func (c Update{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}}) Context() context.Context              { return c.ctx }

// AuditContext returns the audit context.
func (c Update{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}}) AuditContext() audited.AuditContext     { return c.auditCtx }

// Connection returns the database connection.
func (c Update{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}}) Connection() *sql.DB                   { return c.conn }

// Recorder returns the change event recorder.
func (c Update{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}}) Recorder() audited.ChangeEventRecorder { return c.recorder }

// TableName returns the table name for this command.
func (c Update{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}}) TableName() string                     { return "{{$.Entity.TableName}}" }

// Params returns the parameters for this command.
func (c Update{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}}) Params() any                           { return c.params }

// GetID returns the {{lower $.Entity.Singular}} ID for this command.
func (c Update{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}}) GetID() string { return {{$.Entity.IDToString (print "c.params." $.Entity.IDField)}} }

// GetBefore retrieves the {{lower $.Entity.Singular}} before the update.
func (c Update{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}}) GetBefore(ctx context.Context, tx audited.DBTX) ({{$driver.Package}}.{{$.Entity.SqlcTypeName}}, error) {
	queries := {{$driver.Package}}.New(tx)
	return queries.{{$.Entity.GetQueryName}}(ctx, {{$driver.Package}}.{{$.Entity.GetQueryName}}Params{ {{- $.Entity.IDField}}: c.params.{{$.Entity.IDField}}})
}

// Execute updates the {{lower $.Entity.Singular}} in the database.
func (c Update{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}}) Execute(ctx context.Context, tx audited.DBTX) error {
	queries := {{$driver.Package}}.New(tx)
	return queries.Update{{$.Entity.Singular}}(ctx, {{$driver.Package}}.Update{{$.Entity.Singular}}Params{
{{- range $.Entity.NonIDUpdateFields}}
		{{.SqlcFieldName}}: c.params.{{.AppName}},
{{- end}}
{{- range $.Entity.Fields}}
{{- if and .IsPrimaryID .InUpdate}}
		{{.SqlcFieldName}}: c.params.{{.AppName}},
{{- end}}
{{- end}}
	})
}

// Update{{$.Entity.Singular}}Cmd creates a command for updating a {{lower $.Entity.Singular}}.
func (d {{$driver.Struct}}) Update{{$.Entity.Singular}}Cmd(ctx context.Context, auditCtx audited.AuditContext, params Update{{$.Entity.Singular}}Params) Update{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}} {
	return Update{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}}{ctx: ctx, auditCtx: auditCtx, params: params, conn: d.Connection, recorder: {{$driver.Recorder}}}
}

// ----- {{driverCommentLabel $driver}} DELETE -----

// Delete{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}} is an audited command for deleting {{lower $.Entity.Plural}}{{if ne $driver.CmdSuffix ""}} in {{driverCommentLabel $driver}}{{end}}.
type Delete{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}} struct {
	ctx      context.Context
	auditCtx audited.AuditContext
	id       {{$.Entity.IDType}}
	conn     *sql.DB
	recorder audited.ChangeEventRecorder
}

// Context returns the command context.
func (c Delete{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}}) Context() context.Context              { return c.ctx }

// AuditContext returns the audit context.
func (c Delete{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}}) AuditContext() audited.AuditContext     { return c.auditCtx }

// Connection returns the database connection.
func (c Delete{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}}) Connection() *sql.DB                   { return c.conn }

// Recorder returns the change event recorder.
func (c Delete{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}}) Recorder() audited.ChangeEventRecorder { return c.recorder }

// TableName returns the table name for this command.
func (c Delete{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}}) TableName() string                     { return "{{$.Entity.TableName}}" }

// GetID returns the {{lower $.Entity.Singular}} ID for this command.
func (c Delete{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}}) GetID() string { return {{$.Entity.IDToString "c.id"}} }

// GetBefore retrieves the {{lower $.Entity.Singular}} before the delete.
func (c Delete{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}}) GetBefore(ctx context.Context, tx audited.DBTX) ({{$driver.Package}}.{{$.Entity.SqlcTypeName}}, error) {
	queries := {{$driver.Package}}.New(tx)
	return queries.{{$.Entity.GetQueryName}}(ctx, {{$driver.Package}}.{{$.Entity.GetQueryName}}Params{ {{- $.Entity.IDField}}: c.id})
}

// Execute deletes the {{lower $.Entity.Singular}} from the database.
func (c Delete{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}}) Execute(ctx context.Context, tx audited.DBTX) error {
	queries := {{$driver.Package}}.New(tx)
	return queries.Delete{{$.Entity.Singular}}(ctx, {{$driver.Package}}.Delete{{$.Entity.Singular}}Params{ {{- $.Entity.IDField}}: c.id})
}

// Delete{{$.Entity.Singular}}Cmd creates a command for deleting a {{lower $.Entity.Singular}}.
func (d {{$driver.Struct}}) Delete{{$.Entity.Singular}}Cmd(ctx context.Context, auditCtx audited.AuditContext, id {{$.Entity.IDType}}) Delete{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}} {
	return Delete{{$.Entity.Singular}}Cmd{{$driver.CmdSuffix}}{ctx: ctx, auditCtx: auditCtx, id: id, conn: d.Connection, recorder: {{$driver.Recorder}}}
}
{{end}}
{{- end}}
